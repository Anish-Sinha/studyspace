var chatDatabase=null,typingDatabase=null,chatPinnedDatabase=null,songDatabase=null,myApp=angular.module("mainApp",["ngMaterial","ngSanitize"]),CONCAT_TIME=6e4,currPing=null,USER_PING_PERIOD=1e4;myApp.controller("MainController",["$scope","$http","$timeout","$window",function(a,b,c,d){function o(b){if(a.currRoomChatID){m=!1;var c=new XMLHttpRequest;c.open("GET","/typing/false/"+a.currRoomChatID,!0),c.send()}if(a.currRoomChatID!=b){if(a.currRoomChatID=b,null!=chatDatabase&&chatDatabase.off(),e=[],a.chatPinnedMessageList=[],a.showPinnedMessages=!1,a.viewVideo&&a.toggleViewVideo(),j=null,k=!1,w(),a.chatInput="",a.searchQuery=null,a.searchMode=!1,b&&(chatDatabase=databaseRef.child("RoomMessages").child(a.currRoomChatID),chatPinnedDatabase=databaseRef.child("RoomPinnedMessages").child(a.currRoomChatID),v()),null!=typingDatabase&&typingDatabase.off(),l=[],b&&(typingDatabase=databaseRef.child("RoomTyping").child(a.currRoomChatID),p()),null!=songDatabase&&songDatabase.off(),b)songDatabase=databaseRef.child("RoomSong").child(b),songDatabase.on("value",function(a){var b=a.val();if(b)playSong(b);else{var c=document.getElementById("iframePlayer");c.src=""}});else{var d=document.getElementById("iframePlayer");d.src=""}b&&(a.showWhiteboard=!1,t.removeAttribute("src"),u.setAttribute("hidden",null))}}function p(){typingDatabase.on("value",function(b){var c=b.val();c?(l=Object.keys(c),q()):(l=[],a.currTyping=[]),y()})}function q(){for(var b=l.length-1;b>=0;b--);for(var c=[],b=0;b<l.length;b++)l[b]!=myID&&a.users[l[b]]&&c.push(a.users[l[b]].name);a.currTyping=c}function r(c){if(a.currRoomChatID){var d={text:c,roomID:a.currRoomChatID,timeSent:Date.now()};a.rooms[a.currRoomChatID].other_user_id&&(d.other_user_id=a.rooms[a.currRoomChatID].other_user_id),b.post("/send_room_message",d).then(B)}a.chatInput="",g.focus()}function s(a){var b;e.forEach(function(c){c.key==a&&(b=c.text)});var c=b;return c}function v(){n.removeAttribute("hidden"),chatPinnedDatabase.on("child_added",function(b){var c=b.val();a.chatPinnedMessageList.indexOf(c)==-1&&a.chatPinnedMessageList.push(c),w()}),chatDatabase.limitToLast(50).on("child_added",function(a){var b=a.val();b.key=a.key,null==j&&(j=a.key),e.push(b);var c=!1;f.scrollTop+200>=f.scrollHeight-f.clientHeight&&(c=!0),w(),c&&B(),n.setAttribute("hidden",null)}),setTimeout(function(){n.setAttribute("hidden",null)},500)}function w(b){x(),a.chatMessageList=e,y(b)}function x(){for(var a=0;a+1<e.length;)currMessage=e[a],nextMessage=e[a+1],currMessage.email==nextMessage.email&&nextMessage.timeSent<currMessage.timeSent+CONCAT_TIME?(currMessage.text+="\n"+nextMessage.text,e.splice(a+1,1)):a++}function y(b){var c=a.$root.$$phase;"$apply"!=c&&"$digest"!=c?b&&"function"==typeof b?a.$apply(b):a.$apply():b&&"function"==typeof b&&b()}function A(a,b){if(j&&"DONE"!=j){h.removeAttribute("hidden"),k=!0;e.length;chatDatabase.limitToLast(a+1).orderByKey().endAt(j).once("value",function(a){var c=a.val();if(c){j=Object.keys(c)[0];var d=Object.keys(c).map(function(a){var b=c[a];return b.key=a,b});d.pop(),d.length>0?e=d.concat(e):j="DONE";var g=f.scrollHeight,i=f.scrollTop;w();f.scrollHeight;f.scrollTop=i+(f.scrollHeight-g),k=!1}h.setAttribute("hidden",null),b&&b()})}else b&&b()}function B(){f.scrollTop=f.scrollHeight-f.clientHeight}function C(a){var b=new XMLHttpRequest;b.open("GET","/ping",!0),b.onerror=function(){showAlert("no-connection-alert","longaf",!1)},b.send(),a&&(currPing=setTimeout(C,USER_PING_PERIOD,!0))}function E(b){a.my_class_ids.forEach(function(a){a==b&&$("#"+a).is(":hidden")&&$("#"+a).collapse("toggle")})}function F(){var b=new XMLHttpRequest;b.open("GET","/get_my_classes",!0),b.send(),b.onreadystatechange=function(c){if(4==b.readyState&&200==b.status){var d=JSON.parse(b.responseText);for(d.class_ids&&(a.my_class_ids=d.class_ids),a.my_class_ids.push("lounge_id"),i=0;i<a.my_class_ids.length;i++)G(a.my_class_ids[i])}}}function G(b){var c=new XMLHttpRequest;c.open("GET","/get_class/"+b,!0),c.send(),c.onreadystatechange=function(d){if(4==c.readyState&&200==c.status){var e=JSON.parse(c.responseText);e.name=e.name.toLowerCase(),e.rooms_with_tutors=[],a.classes[b]=e,y(),classRoomsDatabase.child(b).on("value",function(a){a.val()&&H(b,Object.values(a.val()))})}}}function H(b,c){var d=a.class_rooms[b]?a.class_rooms[b]:[];for(a.class_rooms[b]=c,d!=c&&y(),i=0;i<d.length;i++)c.indexOf(d[i])==-1&&roomsDatabase.child(d[i]).off();for(i=0;i<c.length;i++)d.indexOf(c[i])==-1&&I(c[i])}function I(b){roomsDatabase.child(b).on("value",function(c){var d=c.val();if(d){var e=[];d.users&&(e=Object.values(d.users),e=e.filter(function(a,b,c){return b==c.indexOf(a)})),a.rooms[b]=new Room(b,d.name,d.host_id,d.class_id,d.is_lecture,e,d.host_name?d.host_name:"Unknown host"),L(a.rooms[b]),K(a.rooms[b].class_id),T(a.rooms[b],q),y();for(var f=0;f<bot_ids.length;f++)J(b,bot_ids[f])}})}function J(b,c){botDatabase.child(c).child(b).off(),botDatabase.child(c).child(b).on("value",function(d){if(d){var e=d.val(),f=a.rooms[b].users.indexOf(c);e&&f==-1?a.rooms[b].users.push(c):e||f==-1||a.rooms[b].users.splice(f,1),T(a.rooms[b]),y()}})}function K(b){for(a.classes[b].num_users=0,i=0;i<a.class_rooms[b].length;i++){var c=a.rooms[a.class_rooms[b][i]];c&&c.users&&(a.classes[b].num_users+=c.users.length)}}function L(b){var c=a.classes[b.class_id].tutor_ids;if(c&&b.users){for(var d=0;d<b.users.length;d++){var e=!1;if(c.indexOf(b.users[d])!=-1){e=!0;break}}b.has_tutor=e;var f=a.classes[b.class_id].rooms_with_tutors.indexOf(b.room_id);f==-1&&b.has_tutor?a.classes[b.class_id].rooms_with_tutors.push(b.room_id):f==-1||b.has_tutor||a.classes[b.class_id].rooms_with_tutors.splice(f,1)}}function T(c,d){if(c)for(var e=0;e<c.users.length;e++)if(!(c.users[e]in a.users)){c.users[e];b.get("/get_user/"+c.users[e]).then(function(b){a.users[b.data.user_id]=b.data,d&&d()})}}function U(){a.messageNotifications={},getSignedCookie("user_id")&&databaseRef.child("Notifications").child(getSignedCookie("user_id")).child("MessageNotifications").once("value",function(c){var d=c.val();if(d){for(var e=Object.keys(d),f=0;f<e.length;f++)a.messageNotifications[e[f]]=d[e[f]];y()}databaseRef.child("Notifications").child(getSignedCookie("user_id")).child("MessageNotifications").on("child_changed",function(c){var d=c.val();d&&(a.getDMID(c.key)!=a.currRoomChatID?(a.messageNotifications[c.key]=d,y()):(b.get("/clear_message_notifications/"+c.key),a.messageNotifications[c.key]=0))})})}function V(){a.buddies_status={};for(var c=0;c<a.added_buddies_list.length;c++){var d=a.added_buddies_list[c].user_two_id;W(d)}}function W(b){databaseRef.child("UserActivity").child(b).child("online").on("value",function(c){c.val()||1==a.buddies_status[b],a.buddies_status[b]=c.val(),X(),y()})}function X(){buddies_online=[],buddies_offline=[];for(var b=0;b<a.added_buddies_list.length;b++)a.buddies_status[a.added_buddies_list[b].user_two_id]?buddies_online.push(a.added_buddies_list[b]):buddies_offline.push(a.added_buddies_list[b]);a.added_buddies_list=buddies_online.concat(buddies_offline)}function Y(a,b){return a.user_two_name.localeCompare(b.user_two_name)}function ea(){a.tempClasses=[];for(var b=0;b<da.length;b++)"lounge_id"!=da[b]&&a.tempClasses.push({class_id:da[b],class_name:ka(da[b])});y()}function fa(a){var b=$.inArray(a,Object.keys(ca).map(function(a){return a}));return b>-1}function ga(b){da.push(b),ea(),a.searchText=""}function ha(b){b=b.concat(["lounge_id"]);var c=!0;b.forEach(function(b){a.my_class_ids.indexOf(b)==-1&&(G(b),c=!1)}),c=c&&a.my_class_ids.length==b.length,a.my_class_ids=b,y(),c||showAlert("course-change-alert","normal",!1)}function ia(){ca={};var a=new XMLHttpRequest;a.open("GET","/get_all_classes",!0),a.send(),a.onreadystatechange=function(b){if(4==a.readyState&&200==a.status)for(var c=JSON.parse(a.responseText),d=0;d<c.length;d++){var e=c[d];"lounge_id"!=e.class_id&&(ca[e.name]=e.class_id)}ea()}}function ja(a){return function(c){var d=a.toUpperCase();return pass=0===c.toUpperCase().indexOf(d),c=c.replace(/\s+/g,""),pass=pass||0===c.toUpperCase().indexOf(d),pass}}function ka(a){for(var b in ca)if(ca[b]==a)return b}a.videoEnabled=!0,a.myID=getSignedCookie("user_id"),a.currRoomCallID=null,a.currRoomChatID=null,a.myName=getSignedCookie("name"),a.logout=function(){leaveRoomHard(a.currRoomCallID),removeCookie("user_id"),removeCookie("email"),removeCookie("name"),window.onbeforeunload=null,window.location.href="/"},a.manageAccount=function(){window.location.href="/courses"};var e=[],f=document.getElementById("chat-message-pane"),g=document.getElementById("chatInputBox"),h=document.getElementById("loading-messages"),j=null,k=!1,l=[],m=!1,n=document.getElementById("loading-overall");a.chatPinnedMessageList=[],a.searchQuery=null,a.searchMode=!0,a.sendChatMessage=function(d){if(d)if(SECRET_COMMANDS.indexOf(d)!=-1){var f=doCommand(d,a.currRoomChatID);if(f)r(f);else if(a.chatInput="",g.focus(),"/stop"===d){var h=document.getElementById("iframePlayer");""!==h.src&&(h.src="",b.post("/broadcast_song/",{room_id:a.currRoomChatID,url:null}))}}else if(0==d.indexOf("/play")){if(d.indexOf("youtube.com")!=-1||d.indexOf("youtu.be")!=-1){var i=d.split(" ");if(i[1]){var j=i[1];b.post("/broadcast_song/",{room_id:a.currRoomChatID,url:j})}}else{var l=d.substring(6);l.length>0&&b.get("/youtube_search/"+l).then(function(c){var d="www.youtube.com/watch?v="+c.data.youtube_video_id;b.post("/broadcast_song/",{room_id:a.currRoomChatID,url:d})})}a.chatInput="",g.focus()}else if(0==d.indexOf("#")){var l=d.substring(1);l.length>0?(a.searchMode=!0,a.searchQuery=l,n.removeAttribute("hidden"),A(1e3,function(){for(var b=[],d=e.length-1;d>=0;d--)(e[d].text.toLowerCase().includes(l.toLowerCase())||e[d].name.toLowerCase().includes(l.toLowerCase()))&&b.unshift(e[d]);a.chatMessageList=b,k=!0,n.setAttribute("hidden",null),c(B)})):(a.searchMode=!1,a.searchQuery=null,n.removeAttribute("hidden"),setTimeout(function(){a.chatMessageList=e,k=!1,n.setAttribute("hidden",null),c(B)},1)),a.chatInput=""}else r(d)},a.messageClicked=function(b){if(a.searchMode){var d=b.currentTarget;a.searchMode=!1,a.searchQuery=null,n.removeAttribute("hidden"),setTimeout(function(){a.chatMessageList=e,y(),k=!1,n.setAttribute("hidden",null),c(function(){f.scrollTop=d.offsetTop})},1)}},a.keypress=function(c){setTimeout(function(){a.chatInput?m||(b.get("/typing/true/"+a.currRoomChatID),m=!0):m&&(b.get("/typing/false/"+a.currRoomChatID),m=!1)},10)},a.muteBtnClass=["glyphicon","glyphicon-volume-up"],a.toggleMic=function(){"glyphicon-volume-up"==a.muteBtnClass[1]?(a.muteBtnClass.pop(),a.muteBtnClass.push("glyphicon-volume-off")):(a.muteBtnClass.pop(),a.muteBtnClass.push("glyphicon-volume-up")),toggleMyStreamAudioEnabled()},a.showPinnedMessages=!1,a.pinChatMessage=function(c,d,e,f){b.post("/pin_message/",{room_id:a.currRoomChatID,chat_message_key:c,user_id:d,name:e,time_sent:f,concat_text:s(c)})},a.togglePinnedMessages=function(){a.showPinnedMessages=!a.showPinnedMessages},a.isPinned=function(b){var c=!1;return a.chatPinnedMessageList.forEach(function(a){a.key==b&&(c=!0)}),c};var t=document.getElementById("whiteboard"),u=document.getElementById("whiteboard-container");a.toggleWhiteboard=function(){a.showWhiteboard?(a.showWhiteboard=!1,console.log("hide"),t.setAttribute("src","whiteboard.html#"+a.currRoomCallID),u.setAttribute("hidden",null)):(a.showWhiteboard=!0,t.setAttribute("src","whiteboard.html#"+a.currRoomCallID),u.removeAttribute("hidden"))};var z=0;a.scrollevent=function(){var a=f.scrollTop;a<=200&&a<z&&(k||A(300)),z=a},a.timeAgo=function(a){var b=new Date(a.timeSent),c=b.getMonth()+1+"/"+b.getDate(),d=b.getHours(),e="AM";d>12?(d-=12,e="PM"):0==d&&(d=12);var f=b.getMinutes();f<10&&(f="0"+f);var g=d+":"+f+" "+e,h=c+" "+g;return h},a.toggleDropdown=function(a){$("#"+a+"_dropdown").click(function(a){a.stopPropagation()}),$("#"+a+"_dropdown").show()},a.my_class_ids=[],a.classes={},a.class_rooms={},a.rooms={},a.users={},a.muted_user_ids=[],a.volumes={ayy:"lmao"},F(),U(),C(!0),a.createRoom=function(a){creationClassID=a,$("#modal-create-room").fadeIn(100),setTimeout(function(){$("#create-room").removeClass("hide"),$("#create-room").addClass("fadeInBack")},100)},a.addRoom=function(){var b=creationClassID,c=document.getElementById("room_name").value.toLowerCase(),d=document.getElementById("lecture-checkbox").checked,e=Date.now();if(null!=b&&0!=c.length){closeModal("#modal-create-room","#create-room");var f=new XMLHttpRequest;f.open("GET","/add_room/"+b+"/"+c+"/"+d+"/"+e+"/"+a.myName,!0),f.send(),f.onreadystatechange=function(b){if(4==f.readyState&&200==f.status){var c=JSON.parse(f.responseText);if(c.error)return;c.room_id&&a.joinRoom(c.room_id,c.class_id)}}}},a.joinRoom=function(b,c){a.currRoomCallID!=b&&(leaveRoom(a.currRoomCallID),a.currRoomCallID=b,joinRoomCall(a.currRoomCallID),E(c)),o(b)},a.setVolumeListener=function(b,c){var d=new SoundMeter(window.audioContext);d.connectToSource(c,function(c){return c?void alert(c):(setInterval(function(){d.loudDetected!=d.loud&&(d.loud=d.loudDetected,a.$apply()),d.loudDetected=!1},500),void(a.volumes[b]=d))})},a.leaveRoom=function(){leaveRoom(a.currRoomCallID),a.currRoomCallID=null,o(null)},a.leaveDM=function(){o(a.currRoomCallID)},d.onbeforeunload=function(){var b=new XMLHttpRequest;b.open("GET","/typing/false/"+a.currRoomChatID,!0),b.send()};var D=$("#classes");D.on("show.bs.collapse",".collapse",function(){D.find(".collapse.in").collapse("hide")}),a.toggleUserAudio=function(b){var c=a.muted_user_ids.indexOf(b);c!=-1?a.muted_user_ids.splice(c,1):a.muted_user_ids.push(b),toggleRemoteStreamAudioEnabled(b)},a.getRemoteStreamExists=function(a){return document.getElementById(a+"_video")},a.getRemoteStreamAudioEnabled=function(a){return document.getElementById(a+"_video")&&!document.getElementById(a+"_video").muted},a.classmateDropdown=function(){$(".dropdown-toggle").dropdown("toggle")},$(".item").click(function(a){a.stopPropagation(),$(".dropdown-toggle").dropdown("toggle")}),a.isBot=function(a){return bot_ids.indexOf(a)!=-1},a.isTutor=function(b,c){return a.classes[a.rooms[c].class_id].tutor_ids&&a.classes[a.rooms[c].class_id].tutor_ids.indexOf(b)!=-1},a.isFriendsWith=function(b){if(!a.added_buddies_list)return-1;var c;for(c=0;c<a.added_buddies_list.length;++c){var d=a.added_buddies_list[c];if(d.user_two_id==b)return c}return-1},a.toggleIsFriend=function(b){var c=a.isFriendsWith(b);c>-1?(a.deleteFriend(b),a.added_buddies_list.splice(c,1)):a.sendRequest(b)};var M=function(a){b.post("/get_my_buddy_requests").then(function(b){return a(b.data)})},N=function(a){b.post("/get_my_buddies").then(function(b){if(b.data[0])return a(b.data[0].buddies)})},O=function(a,c){b.post("/buddy_existing_user",{other_user_id:a}).then(function(a){return c(a.data)})},P=function(a,c){var d={user_id:"user_id placed here",friend_id:String(a)};b.post("/buddy_existing_request",d).then(function(a){return c(a.data)})},Q=function(a,c,d){var e={user_id:"user_id inserted",friend_id:String(a),friend_name:String(c)};b.post("/buddies_already",e).then(function(a){return d(a.data)})},R=function(c,d){b.delete("/reject_buddy/"+c).then(function(b){M(function(b){a.buddies_list=b})})},S=function(a,c){b.post("/accept_buddy",a).then(function(a){return c(a.data)})};M(function(b){a.buddies_list=b}),N(function(b){a.added_buddies_list=b,a.added_buddies_list.sort(Y),V()}),a.sendRequest=function(a){O(a,function(a){if(a){var c=a.user_id,d=a.name;P(c,function(a){a&&0!=a.length||Q(c,d,function(a){if(!a||0==a.length){var e={sent_from_id:"Place user_id here",sent_from_name:"user_name",sent_to_id:String(c),sent_to_name:String(d)};b.post("/send_buddy_request",e).then(function(a){showAlert("buddy-request-alert","normal",!1)})}})})}})},a.sendRequestWithEmail=function(c){b.get("/user_id_from_email/"+c).then(function(b){if(null==b.error){var c=b.data.user_id;a.sendRequest(c),closeModal("#modal-buddy-request","#buddy-request")}})},a.rejectBuddyRequest=function(a){R(a,function(a){})},a.acceptBuddy=function(b){var c={user_one_id:String(b.sent_to_id),user_one_name:String(b.sent_to_name),user_two_id:String(b.sent_from_id),user_two_name:String(b.sent_from_name)};S(c,function(a){R(b._id,function(a){})}),N(function(b){a.added_buddies_list=b})},a.deleteFriend=function(c){b.delete("/remove_buddy/"+c).then(function(b){N(function(b){a.added_buddies_list=b})})},a.getDMID=function(a){return myID>a?myID+a:a+myID},a.openDM=function(c,d){var e=a.getDMID(c);a.classes.dm_class_id={name:""},a.rooms[e]={name:d,class_id:"dm_class_id",other_user_id:c},b.get("/get_user/"+c).then(function(b){a.users[b.data.user_id]=b.data,o(e)}),b.get("/clear_message_notifications/"+c),a.messageNotifications[c]=0},a.openBuddyRequest=function(){$("#modal-buddy-request").fadeIn(100),setTimeout(function(){$("#buddy-request").removeClass("hide"),$("#buddy-request").addClass("fadeInBack")},100)},a.isDank=function(){return getCookie("dank")};var Z={};a.toggleBlock=function(b){a.isBlocked(b)?a.unblock(b):a.blockUserWithId(b)},a.isBlocked=function(a){if(Z.blocked_user_list){var b=Z.blocked_user_list;if(b.indexOf(a)!=-1)return!0}return!1};var aa=function(){Z={},b.get("/get_blocked_users").then(function(b){if(a.block_user_list=b.data,b.data[0]){Z.user_id=b.data[0].blocked_user_id,Z.blocked_user_list=[];for(var c=0;c<b.data.length;c++){var d=b.data[c];Z.blocked_user_list.push(d.blocked_user_id),myCalls[d.blocked_user_id]&&myCalls[d.blocked_user_id].close()}}})},ba=function(a,c){var d={blocked_user_id:String(a)};b.post("/add_blocked_user",d).then(function(a){c(a.data)})};aa(),a.blockUserWithId=function(a){ba(a,function(a){showAlert("block-alert","normal",!1),aa()})},a.unblock=function(a){b.delete("/remove_block/"+a).then(function(a){aa()})},a.viewVideo=!1,a.userStreamSources={},a.toggleViewVideo=function(){a.viewVideo=!a.viewVideo,a.viewVideo||setMyStreamVideoEnabled(!1,!1),a.viewVideo&&showVideo&&setMyStreamVideoEnabled(!0)},a.setMyStreamVideoEnabled=function(a,b){void 0==b&&(b=!0),setMyStreamVideoEnabled(a,b)},a.getVideoEnabled=function(a){if(void 0==a&&(a=myID),a==myID)return myStream&&myStream.getVideoTracks()[0].enabled};var ca=null,da=[];a.refreshAddClass=function(){da=a.my_class_ids.slice(),da.splice(da.indexOf("lounge_id"),1),null==ca?ia():ea()},a.processSelection=function(){if(a.selectedItem){var c=a.selectedItem;if(fa(c)){var d=ca[c];$.inArray(d,da)==-1&&ga(d)}}},a.removeClass=function(a){var b=$.inArray(a,da);da.splice(b,1),ea()},a.saveChanges=function(){b.post("/enroll",{class_ids:da}),closeModal("#modal-add-class","#add-class"),ha(da)},a.querySearch=function(b){return b?Object.keys(ca).filter(ja(b)):[]},a.whiteboardURL=function(){return"whiteboard.html#"+a.currRoomCallID}}]),myApp.directive("scroll",function(a){return{scope:{scrollEvent:"&"},link:function(a,b,c){$("#"+c.id).scroll(function(b){null!=a.scrollEvent?a.scrollEvent()(b):null})}}}),myApp.filter("highlight",function(a){return function(b,c){return c&&(b=b.replace(new RegExp("("+c+")","gi"),'<span class="highlighted">$1</span>')),a.trustAsHtml(b)}});
