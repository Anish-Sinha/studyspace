<!--
   _____     ______     __   __     __  __
  /\  __-.  /\  __ \   /\ "-.\ \   /\ \/ /
  \ \ \/\ \ \ \  __ \  \ \ \-.  \  \ \  _"-.
   \ \____-  \ \_\ \_\  \ \_\\"\_\  \ \_\ \_\
    \/____/   \/_/\/_/   \/_/ \/_/   \/_/\/_/

-->

<!DOCTYPE html>
<html ng-app="mainApp" ng-app="classesApp">
  <head>

    <!-- Bootstrap -->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.1/angular.min.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>  

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <!-- For mobile scaling -->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Stylesheets -->
    <link rel="stylesheet" type="text/css" href="general.css">
    <link rel="stylesheet" type="text/css" href="mainRoom.css">
    <link rel="stylesheet" type="text/css" href="animations.css">

    <!-- Additional Typefaces -->
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,500,600,700" rel="stylesheet">

    <!-- javascript files -->
    <script type="text/javascript" src="toggleMenu.js"></script>

    <!-- Title -->
    <title>Main Room</title>
  </head>

  <body id="myBody" ng-controller="MainController">

    <!-- Classes Sidebar -->
    <aside id="classes-sidebar" class="sidebar sidebar-left" role="complementary">

      <!-- User Quick Info -->
      <div id="user-info" class="container-info-user">
        <div class="container-user-icon">
          <span>{{myName | limitTo:1}}</span>
        </div>
        <span class="user-name" style="color:#38c9ff">{{myName}}</span>
      </div>

      <!-- Log Out -->
      <button id="log-out" class="btn btn-sm btn-low-pri" onclick="logOut()">Log Out</button>

      <!-- User Preference -->
      <a id="preferences" class="btn btn-sm btn-low-pri" href="courses">Account</a>

      <!-- Classes -->
      <div id="classes-menu" class="container-menu-classes">

        <!-- Create Room Button -->
        <button id="btn-create-room" class="btn container-title">
          <span class="title">Spaces</span>
          <div>
            <span class="glyphicon glyphicon-plus"></span>
          </div>
        </button>

        <!-- Classes/Rooms Dropdown -->
        <div id="classes" class="panel-group menu-classes">

          <div ng-repeat="(class_id, class_obj) in classes" ng-if="class_id != 'dm_class_id'" id="#{{class_id}}" class="panel" href="#{{class_id}}">
            <div class="panel-heading" data-toggle="collapse" data-target="#{{class_id}}" data-parent="#classes">
              <h4 class="panel-title">
                <span class="badge" style="color:{{!currRoomCallID ? '#ffffff' : (class_id == rooms[currRoomCallID].class_id ? '#38c9ff' : '')}}">{{class_obj.name}} ({{classes[class_id].num_users}}){{class_obj.has_tutor ? " *":""}}</span>
              </h4>
            </div>
            <div id="{{class_id}}" class="panel-collapse collapse">
              <ul class="list-group">
                <li class="list-group-item" ng-repeat="room_id in class_rooms[class_id]" ng-click="joinRoom(room_id, class_id)">
                  <span style="color:{{room_id == currRoomCallID ? '#38c9ff' : '#ffffff'}}" class="room-name-span">
                    {{getStringToFit(rooms[room_id].name)}} ({{rooms[room_id].users.length}}) {{rooms[room_id].has_tutor? "*":""}}
                  </span>
                </li>
              </ul>
            </div>
          </div>

        </div> <!-- END PANEL-GROUP -->

      </div>
    </aside> <!-- END LEFT SIDEBAR -->

    <div id="main-initial" class="chat-room" role="main" ng-hide="currRoomChatID" style="position:relative; height:100%">
      <p class="text-center" style="color: #38c9ff; font-size: 4rem; font-weight: 500; 
      position:absolute; top: 40%; left:40%; width:20%; height: 20%;">studyspace</p>
    </div>

    <!-- Main Content -->
    <main id="main" class="chat-room" role="main" ng-hide="!currRoomChatID">
      <!-- ROOM NAVBAR -->
      <nav id="class-navigation" class="navbar navbar-room">
        <div class="container-fluid">
          <div class="navbar-header">
            <span class="navbar-brand">{{classes[rooms[currRoomChatID].class_id].name != "" ? 
              classes[rooms[currRoomChatID].class_id].name + " - ":""}}{{rooms[currRoomChatID].name}}</span>
          </div>
          <ul class="nav navbar-nav navbar-right">
            <li class="dropdown">
              <a class="dropdown-toggle" data-toggle="dropdown" href="#">Rooms <span class="caret"></span></a>
              <ul class="dropdown-menu" id="room-list">
                <li ng-repeat="room_id in class_rooms[rooms[currRoomChatID].class_id]" ng-click="joinRoom(room_id, rooms[room_id].class_id)">
                  <a href="#">{{rooms[room_id].name}}</a>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </nav>

      <!-- MESSAGE PANE -->
      <div id="overlay">
      <div id="chat-message-pane" class="message-pane container-fluid" scroll scroll-event="scrollevent">
        <div id="loading" hidden> 
          <div class="blob blob-0"></div><div class="blob blob-1"></div>
          <div class="blob blob-2"></div><div class="blob blob-3"></div>
          <div class="blob blob-4"></div><div class="blob blob-5"></div>
        </div>
        <div class="message" ng-repeat="chatMessage in chatMessageList">
          <div class="container-user-icon">
            <span>{{chatMessage.name | limitTo:1}}</span>
          </div>
          <div class="message-content">
            <header class="message-header">
              <div class="dropdown">

                <!-- Dropdown for non-me users -->
                <a ng-if="chatMessage.user_id != myID" class="user-name dropdown-toggle" data-toggle="dropdown" href="#">{{chatMessage.name}} <span class="caret"></span></a>
                <ul ng-if="chatMessage.user_id != myID" class="dropdown-menu">
                  <li><a href="#" onclick="toggleRemoteStreamAudioEnabled(chatMessage.user_id)">Mute</a></li>
                  <li><a href="#">Block</a></li>
                  <li><a href="#">Friend</a></li>
                </ul>

                <!-- No dropdown if user is me -->
                <a ng-if="chatMessage.user_id == myID" class="user-name">{{chatMessage.name}}</a>

              </div>
            <span class="dateTime">{{timeAgo(chatMessage)}}</span>
            </header>
            <p class="message-body">{{chatMessage.text}}</p>
         </div>
       </div>
      </div> 

       <div id="voice-connect-alert" class="alert fade in alert-info text-center">
        <a class="close" data-dismiss="alert">Ã—</a>
        <span>Voice connected</span>
       </div>
      </div>
      <!-- END MESSAGE PANE -->

      <!-- MESSAGE INPUT -->
      <footer id="message-box" class="form-message-container">
        <form class="form-message" ng-submit="sendChatMessage(chatInput)">
          <div class="input-group">
            <span class="input-group-btn">
              <button id="mute-button" class="btn btn-mute text-center" type="button" ng-click="toggleMic()"> 
                <span ng-class="muteBtnClass"></span>
              </button>
              <button class="btn text-center" type="button" ng-click="leaveRoom()">LeaveRoom</button>
            </span>
            <input type="text" class="form-control input-message" id="chatInputBox" 
                   ng-model="chatInput" placeholder="Type a message..." autocomplete="off">
          </div>
        </form>
      </footer> <!-- END MESSAGE INPUT -->

    </main>   

    <!-- Classmates Sidebar -->
    <aside id="classmates-sidebar" class="sidebar sidebar-right" role="complementary">
      <h3>Buddies</h3>   
      <div class="container-search">
        <input class="form-control" ng-model="friend.name">
        <button class="btn btn-primary" ng-click="sendRequest()">Send Request</button>
        <table class="table">
          <tbody>   
            <tr ng-repeat="buddy_requests in buddies_list">
              <td></td>
              <td>{{buddy_requests.sent_from_name}}</td>
              <td><button class="btn" ng-click="acceptBuddy(buddy_requests)">Accept Request</button></td>
              <td><button class="btn btn-danger" ng-click="rejectBuddyRequest(buddy_requests._id)">Reject Request</button></td>
            </tr>
          </tbody>
        </table>
        Friends
        <table class="table">
          <tbody>   
            <tr ng-repeat="buddy in added_buddies_list">
              <td></td>
              <td>{{buddy.user_two_name}}</td>
              <td><button class="btn btn-danger" ng-click="deleteFriend(buddy.user_two_id)">Remove Friend</button></td>
              <td><button class="btn btn-danger" ng-click="openDM(buddy.user_two_id, buddy.user_two_name)">Open DM</button></td>
            </tr>
          </tbody>
        </table>
      </div> 
      <div class="container">
      <!--
        <input class="form-control" ng-model="user_preferences.school">
        <button class="btn btn-primary" ng-click="addSchool()">Add School</button></th>
        -->
        <table class="table">
          <thead>
            <tr>
              <th>Block User</th>
              <th><input class="form-control" ng-model="block_user.name"></th>
              <th><button class="btn btn-primary" ng-click="blockUser()">Block User</button></th>
            </tr>
          </thead>
          <tbody>
            <tr ng-repeat="block_user in block_user_list">
              <td></td>
              <td>{{block_user.blocked_user_email}}</td>
              <td><button class="btn btn-danger" ng-click="unblock(block_user._id)">Unblock</button></td>
            </tr>
          </tbody>
        </table>
      </div>
    </aside>

    <!-- Create Room Modal -->
    <div id="modal-create-room" class="modal modal-create-room-container" role="dialog">
      <div class="modal-dialog">

        <!-- Content -->
        <div id="create-room" class="modal-content modal-create-room-content hide">
          <header class="modal-header text-center"> 
            <button id="close-create-room" class="btn close" data-dismiss="modal" aria-label="Close">
              <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
            </button>
            <h1 class="title primary-dark-text">Create a room</h1>
          </header>
          <div class="main form-container">

            <!-- Class selection -->
            <form role="form" accept-charset="UTF-8" autocomplete="off">
              <div class="form-group">
                <label for="class">Class</label><br/>
                <div class="radio" ng-repeat="class_id in my_class_ids">
                  <label>
                    <input type="radio" name="class_id_radio" value="{{class_id}}">
                    {{classes[class_id].name}}
                  </label>
                </div>
              </div>
              <div class="form-group">
                <label for="room_name">Room Name</label>
                <input type="text" class="form-control" maxlength="28" placeholder="e.g. Midterm Review" id="room_name">
              </div>
              <div class="btn-container text-center">
                <button type="submit" class="btn btn-primary btn-block btn-submit-form btn-hi-pri" ng-click="addRoom()">Create</button>
              </div>
            </form>

          </div>
        </div>

      </div>
    </div>
    <audio id="join_room_audio" src="/audio/join_room_sfx" volume=0.5></audio>
    <audio id="leave_room_audio" src="/audio/leave_room_sfx"></audio>

  </body>

  <!-- Peer -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/0.3.14/peer.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/3.6.7/firebase.js"></script>
  <script src="firebase_setup.js"></script>

  <!-- Angular scripts -->
  <script src="controllers/main_controller.js"></script>

  <!-- Other -->
  <script src="cookies.js"></script>
  <script src="main.js"></script>
  <script src="call.js"></script>

</html>
