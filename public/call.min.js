function getMedia(a){navigator.getUserMedia({video:!0,audio:!0},function(b){myStream=b,setMyStreamVideoEnabled(!1),addRemoteStream(myStream,myID),angular.element(document.getElementById("myBody")).scope().setVolumeListener(myID,myStream),showAlert("media-connect-alert","short"),a&&a()},function(a){})}function pingPeerServer(a){peer.socket.send({type:"Ping"}),a&&setTimeout(pingPeerServer,PEER_PING_PERIOD,!0)}function startCall(a){me.block_list.indexOf(a)==-1&&(null!=myStream?startCallHelper(a):getMedia(startCallHelper(a)))}function startCallHelper(a){var b=peer.call(a,myStream);if(b){myCalls[a]=b,b.on("stream",function(a){establishCall(a,b.peer)});b.id;b.on("close",function(){destablishCall(b.peer)})}}function answerCall(a){null!=myStream?answerCallHelper(a):getMedia(answerCallHelper(a))}function answerCallHelper(a){a.answer(myStream),myCalls[a.peer]=a,a.on("stream",function(b){establishCall(b,a.peer)});a.id;a.on("close",function(){destablishCall(a.peer)})}function establishCall(a,b){angular.element(document.getElementById("myBody")).scope().setVolumeListener(b,a),addRemoteStream(a,b),document.getElementById("join_room_audio").play()}function destablishCall(a){removeRemoteStream(a),document.getElementById("leave_room_audio").play()}function joinRoomCall(a){var b=new XMLHttpRequest;b.open("GET","/join_room/"+a,!0),b.send(),b.onreadystatechange=function(c){if(4==b.readyState&&200==b.status){var d=JSON.parse(b.responseText);if(null==d.room_id)return;if(setOnBeforeUnload(a),isLecturer=d.is_lecture&&d.host_id==myID,d.is_lecture&&showAlert("lecture-alert"),d.is_lecture&&!isLecturer)startCall(d.host_id),setMyStreamAudioEnabled(!1);else{null==myStream&&showAlert("no-permissions-alert","normal",!1);var e=Object.values(d.users);for(i=0;i<e.length;i++){var f=e[i];f!=myID&&startCall(f)}}}}}function leaveRoom(a){if(null!=a){leaveCalls();var b=new XMLHttpRequest;b.open("GET","/leave_room/"+a,!0),b.send(),stopSong()}}function addRemoteStream(a,b){angular.element(document.getElementById("myBody")).scope().userStreamSources[b]=window.URL.createObjectURL(a),angular.element(document.getElementById("myBody")).scope().$apply(),isLecturer&&toggleRemoteStreamAudioEnabled(b)}function removeRemoteStream(a){delete angular.element(document.getElementById("myBody")).scope().userStreamSources[a]}function leaveCalls(){for(user_id in myCalls)myCalls[user_id].close();myCalls={}}function toggleMyStreamAudioEnabled(){myStream.getAudioTracks()[0].enabled=!myStream.getAudioTracks()[0].enabled}function setMyStreamAudioEnabled(a){myStream&&(myStream.getAudioTracks()[0].enabled=a)}function setMyStreamVideoEnabled(a,b){void 0==b&&(b=!0),myStream&&(myStream.getVideoTracks()[0].enabled=a,b&&(showVideo=a),a&&showAlert("video-alert","long"))}function toggleRemoteStreamAudioEnabled(a){document.getElementById(a+"_video")&&(document.getElementById(a+"_video").muted=!document.getElementById(a+"_video").muted)}function setOnBeforeUnload(a){window.onbeforeunload=function(b){leaveRoomHard(a)}}function leaveRoomHard(a){if(null!=a){var b=new XMLHttpRequest;b.open("GET","/leave_room/"+a,!1),b.send()}}var me={user_id:"id2",block_list:["block1"]},currRoomUsers=[],isLecturer=!1,peer=new Peer(myID,{host:"pacific-lake-64902.herokuapp.com",port:"",path:"/peerjs"});peer._lastServerId=myID;var PEER_PING_PERIOD=3e4,myStream=null,myCalls={},myRemoteStreams={},videoContainers=[],showVideo;navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia,getMedia(),peer.on("open",function(){setTimeout(pingPeerServer,5e3,!0)}),peer.on("call",function(a){me.block_list.indexOf(a.peer)==-1&&answerCall(a)}),peer.on("disconnected",function(){}),peer.on("error",function(a){});
